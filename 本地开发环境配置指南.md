# 本地开发环境配置指南

## 1. 前置要求

确保已安装以下软件：

- **Python 3.13+**
  - 下载：https://www.python.org/downloads/
  - 验证：`python3 --version`

- **Poetry**（Python 依赖管理工具）
  - 安装：`curl -sSL https://install.python-poetry.org | python3 -`
  - 验证：`poetry --version`

- **Docker Desktop**
  - 下载：https://www.docker.com/products/docker-desktop
  - 验证：`docker --version`
  - **必需：用于通过脚本运行 Redis 和 RabbitMQ**

---

## 2. 启动基础设施服务

使用提供的脚本管理 Docker 容器中的 Redis 和 RabbitMQ：

```bash
# 检查环境和前置条件
./scripts/check-environment.sh

# 启动 Docker 容器中的 Redis 和 RabbitMQ
./scripts/start-services.sh

# 需要时停止服务
./scripts/stop-services.sh
```

---

## 3. 环境配置

每个服务都需要 `.env` 配置文件。为每个服务复制 `.env.example` 模板到 `.env`：

### 3.1 Gateway Service（网关服务）

```bash
cd gateway-service
cp .env.example .env
```

**重要配置说明：**
- `SECRET_KEY`：**必须与** Auth Service 的 `JWT_SECRET_KEY` 完全相同
- 默认值：`auth-service-secret-key-2025`
- 服务 URL：指向 `localhost:800X`（X = 0,2,3,4,5,6）

**配置文件内容：**
```env
# 网关服务基本配置
SERVICE_NAME=gateway-service
PORT=8080
LOG_LEVEL=INFO

# 微服务 URL 配置
AUTH_SERVICE_URL=http://localhost:8000
USER_SERVICE_URL=http://localhost:8002
ORDER_SERVICE_URL=http://localhost:8003
PAYMENT_SERVICE_URL=http://localhost:8004
REVIEW_SERVICE_URL=http://localhost:8005
NOTIFICATION_SERVICE_URL=http://localhost:8006

# JWT 配置（必须与 Auth Service 的 JWT_SECRET_KEY 相同！）
SECRET_KEY=auth-service-secret-key-2025
ALGORITHM=HS256

# 限流配置
RATE_LIMIT_PER_MINUTE=60
```

### 3.2 Auth Service（认证服务）

```bash
cd services/auth-service
cp .env.example .env
```

**重要配置说明：**
- `DATABASE_URL`：MySQL 数据库连接字符串（`auth_db`）
- `JWT_SECRET_KEY`：**必须与** Gateway Service 的 `SECRET_KEY` 相同
- `LOCAL_RABBITMQ_URL` / `DOCKER_RABBITMQ_URL`：根据环境选择

**配置文件内容：**
```env
# MySQL 数据库连接配置
DATABASE_URL=mysql+aiomysql://freelancer:password123@freelancer-db.c1ie6ii2q3oy.ap-southeast-1.rds.amazonaws.com:3306/auth_db

# JWT Token 配置（必须与 Gateway Service 的 SECRET_KEY 相同！）
JWT_SECRET_KEY=auth-service-secret-key-2025
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# RabbitMQ 消息队列配置
LOCAL_RABBITMQ_URL=amqp://guest:guest@localhost:5672/
DOCKER_RABBITMQ_URL=amqp://guest:guest@freelancer-rabbitmq:5672/

# 服务基本配置
SERVICE_NAME=auth-service
SERVICE_PORT=8000
LOG_LEVEL=INFO
```

### 3.3 User Service（用户服务）

```bash
cd services/user-service
cp .env.example .env
```

**重要配置说明：**
- `MONGODB_URL`：MongoDB 连接字符串（`user_db`）
- `AUTH_SERVICE_URL`：应为 `http://localhost:8000`

**配置文件内容：**
```env
# MongoDB 数据库连接配置
MONGODB_URL=mongodb+srv://freelancer:Password123@freelancer-cluster.rhf5ws4.mongodb.net/user_db?retryWrites=true&w=majority&appName=freelancer-cluster

# RabbitMQ 消息队列配置
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# 服务基本配置
SERVICE_NAME=user-service
SERVICE_PORT=8002
LOG_LEVEL=INFO

# 外部服务地址配置
AUTH_SERVICE_URL=http://localhost:8000
```

### 3.4 Order Service（订单服务）

```bash
cd services/order-service
cp .env.example .env
```

**重要配置说明：**
- `DATABASE_URL`：MySQL 数据库连接字符串（`order_db`）
- `AUTH_SERVICE_URL`：应为 `http://localhost:8000`
- `USER_SERVICE_URL`：应为 `http://localhost:8002`

**配置文件内容：**
```env
# MySQL 数据库连接配置
DATABASE_URL=mysql+aiomysql://freelancer:password123@freelancer-db.c1ie6ii2q3oy.ap-southeast-1.rds.amazonaws.com:3306/order_db

# RabbitMQ 消息队列配置
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# 服务基本配置
SERVICE_NAME=order-service
SERVICE_PORT=8003
LOG_LEVEL=INFO

# 外部服务地址配置
AUTH_SERVICE_URL=http://localhost:8000
USER_SERVICE_URL=http://localhost:8002
```

### 3.5 Payment Service（支付服务）

```bash
cd services/payment-service
cp .env.example .env
```

**重要配置说明：**
- `DATABASE_URL`：MySQL 数据库连接字符串（`payment_db`）
- `AUTH_SERVICE_URL`：应为 `http://localhost:8000`
- `USER_SERVICE_URL`：应为 `http://localhost:8002`
- `ORDER_SERVICE_URL`：应为 `http://localhost:8003`

**配置文件内容：**
```env
# MySQL 数据库连接配置
DATABASE_URL=mysql+aiomysql://freelancer:password123@freelancer-db.c1ie6ii2q3oy.ap-southeast-1.rds.amazonaws.com:3306/payment_db

# RabbitMQ 消息队列配置
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# 服务基本配置
SERVICE_NAME=payment-service
SERVICE_PORT=8004
LOG_LEVEL=INFO

# 外部服务地址配置
AUTH_SERVICE_URL=http://localhost:8000
USER_SERVICE_URL=http://localhost:8002
ORDER_SERVICE_URL=http://localhost:8003
```

### 3.6 Review Service（评价服务）

```bash
cd services/review-service
cp .env.example .env
```

**重要配置说明：**
- `MONGODB_URL`：MongoDB 连接字符串（`review_db`）
- `AUTH_SERVICE_URL`：应为 `http://localhost:8000`
- `ORDER_SERVICE_URL`：应为 `http://localhost:8003`
- `USER_SERVICE_URL`：应为 `http://localhost:8002`

**配置文件内容：**
```env
# MongoDB 数据库连接配置
MONGODB_URL=mongodb+srv://freelancer:Password123@freelancer-cluster.rhf5ws4.mongodb.net/review_db?retryWrites=true&w=majority&appName=freelancer-cluster

# RabbitMQ 消息队列配置
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# 服务基本配置
SERVICE_NAME=review-service
SERVICE_PORT=8005
LOG_LEVEL=INFO

# 外部服务地址配置
AUTH_SERVICE_URL=http://localhost:8000
ORDER_SERVICE_URL=http://localhost:8003
USER_SERVICE_URL=http://localhost:8002
```

### 3.7 Notification Service（通知服务）

```bash
cd services/notification-service
cp .env.example .env
```

**重要配置说明：**
- `MONGODB_URL`：MongoDB 连接字符串（`notification_db`）
- `REDIS_URL`：应为 `redis://localhost:6379`
- 需要配置所有 5 个微服务的 URL（这是最复杂的服务配置）

**配置文件内容：**
```env
# MongoDB 数据库连接配置
MONGODB_URL=mongodb+srv://freelancer:Password123@freelancer-cluster.rhf5ws4.mongodb.net/notification_db?retryWrites=true&w=majority&appName=freelancer-cluster

# Redis 缓存数据库配置
REDIS_URL=redis://localhost:6379

# RabbitMQ 消息队列配置
RABBITMQ_URL=amqp://guest:guest@localhost:5672/

# 服务基本配置
SERVICE_NAME=notification-service
SERVICE_PORT=8006
LOG_LEVEL=INFO

# 外部服务地址配置
AUTH_SERVICE_URL=http://localhost:8000
USER_SERVICE_URL=http://localhost:8002
ORDER_SERVICE_URL=http://localhost:8003
PAYMENT_SERVICE_URL=http://localhost:8004
REVIEW_SERVICE_URL=http://localhost:8005
```

---

## 4. 依赖安装

使用 Poetry 为每个服务安装 Python 依赖。Poetry 会自动创建虚拟环境并安装所有依赖包。

### 4.1 Gateway Service（网关服务）

```bash
cd gateway-service
poetry install
# 会创建虚拟环境并安装所有依赖
```

### 4.2 Auth Service（认证服务）

```bash
cd services/auth-service
poetry install
```

### 4.3 User Service（用户服务）

```bash
cd services/user-service
poetry install
```

### 4.4 Order Service（订单服务）

```bash
cd services/order-service
poetry install
```

### 4.5 Payment Service（支付服务）

```bash
cd services/payment-service
poetry install
```

### 4.6 Review Service（评价服务）

```bash
cd services/review-service
poetry install
```

### 4.7 Notification Service（通知服务）

```bash
cd services/notification-service
poetry install
```

---

## 5. 服务启动

### 5.1 启动 Auth Service

**必须首先启动 Auth Service**，因为其他所有服务都需要它来验证用户 Token。

```bash
cd services/auth-service
poetry run uvicorn auth_service.main:app --reload --host 0.0.0.0 --port 8000 --app-dir src
```

启动成功后，您应该看到类似以下的输出：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### 5.2 启动其他微服务

为每个服务打开独立的终端窗口或标签页：

#### 终端 2 - User Service（用户服务）
```bash
cd services/user-service
poetry run uvicorn user_service.main:app --reload --host 0.0.0.0 --port 8002 --app-dir src
```

#### 终端 3 - Order Service（订单服务）
```bash
cd services/order-service
poetry run uvicorn order_service.main:app --reload --host 0.0.0.0 --port 8003 --app-dir src
```

#### 终端 4 - Payment Service（支付服务）
```bash
cd services/payment-service
poetry run uvicorn payment_service.main:app --reload --host 0.0.0.0 --port 8004 --app-dir src
```

#### 终端 5 - Review Service（评价服务）
```bash
cd services/review-service
poetry run uvicorn review_service.main:app --reload --host 0.0.0.0 --port 8005 --app-dir src
```

#### 终端 6 - Notification Service（通知服务）
```bash
cd services/notification-service
poetry run uvicorn notification_service.main:app --reload --host 0.0.0.0 --port 8006 --app-dir src
```

### 5.3 启动 Gateway Service

**最后启动 Gateway Service**，确保所有后端服务都已就绪。

```bash
cd gateway-service
poetry run uvicorn gateway_service.main:app --reload --host 0.0.0.0 --port 8080 --app-dir src
```

### 服务端口总结

| 服务名称 | 端口 | 说明 |
|---------|------|------|
| Gateway Service | 8080 | 网关服务（API 统一入口） |
| Auth Service | 8000 | 认证服务 |
| User Service | 8002 | 用户服务 |
| Order Service | 8003 | 订单服务 |
| Payment Service | 8004 | 支付服务 |
| Review Service | 8005 | 评价服务 |
| Notification Service | 8006 | 通知服务 |

---

## 6. 验证测试

### 6.1 健康检查端点

测试每个服务的健康检查端点，确保所有服务都正常运行：

```bash
# Gateway Service（端口 8080）
curl http://localhost:8080/health

# Auth Service（端口 8000）
curl http://localhost:8000/health

# User Service（端口 8002）
curl http://localhost:8002/health

# Order Service（端口 8003）
curl http://localhost:8003/health

# Payment Service（端口 8004）
curl http://localhost:8004/health

# Review Service（端口 8005）
curl http://localhost:8005/health

# Notification Service（端口 8006）
curl http://localhost:8006/health
```

**预期响应：**
```json
{
  "status": "healthy",
  "service": "service-name",
  "timestamp": "2025-10-17T12:00:00Z"
}
```

如果服务正常运行，所有健康检查都应该返回上述 JSON 响应。

---

## 7. 故障排查

### 7.1 端口被占用

**错误信息：**
```
OSError: [Errno 48] Address already in use
```

**原因：**指定的端口已经被其他进程占用。

**解决方案：**

```bash
# 查找占用端口的进程（例如查找 8000 端口）
lsof -i :8000

# 输出示例：
# COMMAND   PID   USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME
# Python  12345  user   3u  IPv4  0x1234567      0t0  TCP *:8000 (LISTEN)

# 杀死占用端口的进程
kill -9 <PID>
# 例如：kill -9 12345

# 或者使用其他端口启动服务
poetry run uvicorn auth_service.main:app --reload --port 8001 --app-dir src
```

---
